<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diario y Mapa de Emociones Avanzado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }
        .emotion-arc-group {
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        .emotion-arc-group:hover {
            transform: scale(1.03);
        }
        .emotion-arc-path {
             transition: filter 0.3s ease;
        }
        .emotion-arc-group:hover .emotion-arc-path {
            filter: brightness(1.15);
        }
        .emotion-label {
            pointer-events: none;
            fill: white;
            font-weight: 500;
            text-anchor: middle;
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.7);
            z-index: 40;
        }
        .modal {
            z-index: 50;
        }
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 30;
            backdrop-filter: blur(10px);
            background-color: rgba(17, 24, 39, 0.85);
        }
        .step-content-container {
            display: none; /* Initially hidden, controlled by GSAP */
        }
        .writing-mode-btn {
            transition: all 0.2s ease-in-out;
        }
        .writing-mode-btn.active {
            background-color: #4F46E5; /* Indigo 600 */
            color: white;
        }
        .writing-mode-btn.inactive {
            background-color: #374151; /* Gray 700 */
            color: #9CA3AF; /* Gray 400 */
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <!-- Modal de Bienvenida/Registro -->
    <div id="welcome-modal" class="fixed inset-0 flex items-center justify-center modal-backdrop hidden">
        <div class="bg-gray-800 rounded-2xl p-8 shadow-2xl border border-gray-700 modal w-11/12 max-w-md text-center">
            <img src="https://placehold.co/200x50/1f2937/FFFFFF?text=cursosanimikdemi.png" alt="Logo Cursos Animik Demi" class="h-12 mx-auto mb-6" onerror="this.onerror=null;this.src='https://placehold.co/200x50/1f2937/FFFFFF?text=Logo';">
            <h2 class="text-3xl font-bold mb-4 text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600">¡Bienvenido/a!</h2>
            <p class="text-gray-300 mb-6">Para personalizar tu experiencia, por favor dinos tu nombre.</p>
            <form id="profile-form">
                <div class="mb-4">
                    <input type="text" id="first-name" placeholder="Nombre" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                </div>
                <div class="mb-6">
                    <input type="text" id="last-name" placeholder="Apellido" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                </div>
                <button type="submit" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300">Guardar y Empezar</button>
            </form>
        </div>
    </div>

    <!-- Contenido Principal de la App -->
    <div id="app-content" class="hidden h-screen flex flex-col">
        <header class="w-full py-4 px-6 sticky-header border-b border-gray-700/50">
            <div class="max-w-7xl mx-auto flex justify-between items-center">
                 <img src="https://placehold.co/200x50/111827/FFFFFF?text=cursosanimikdemi.png" alt="Logo Cursos Animik Demi" class="h-10" onerror="this.onerror=null;this.src='https://placehold.co/200x50/111827/FFFFFF?text=Logo';">
                 <div id="welcome-message" class="text-lg text-gray-300"></div>
            </div>
        </header>

        <main class="flex-1 flex flex-col p-6 gap-4 overflow-hidden">
            <!-- Cabecera de Pasos (Compartida) -->
            <div id="step-header" class="text-center max-w-3xl mx-auto">
                <h2 id="step-title" class="text-4xl font-bold"></h2>
                <p id="step-subtitle" class="text-gray-400 text-lg mt-2"></p>
                <p id="emotion-description-header" class="text-gray-300 text-sm mt-3 h-10"></p>
            </div>

            <!-- Contenedor de Contenido de Pasos -->
            <div id="content-area" class="flex-1 flex flex-col items-center justify-center overflow-hidden relative">
                <!-- Step 1: Primary Emotions -->
                <div id="step1-content" class="step-content-container w-full h-full flex items-center justify-center">
                    <svg id="primary-emotion-map" class="w-full h-full" viewBox="0 0 600 600"></svg>
                </div>

                <!-- Step 2: Secondary Emotions -->
                <div id="step2-content" class="step-content-container w-full h-full flex items-center justify-center">
                    <svg id="secondary-emotion-map" class="w-full h-full" viewBox="0 0 600 600"></svg>
                </div>

                <!-- Step 3: Diary Entry -->
                <div id="step3-content" class="step-content-container w-full max-w-5xl h-full flex flex-col md:flex-row gap-6 items-start">
                    <div class="w-full md:w-1/2 flex flex-col gap-6">
                        <div class="bg-gray-800 rounded-2xl p-6 shadow-xl border border-gray-700">
                            <div class="flex items-center justify-center gap-2 mb-4 p-1 bg-gray-700 rounded-lg">
                                <button id="free-write-btn" class="writing-mode-btn w-1/2 py-2 rounded-md active">Libre</button>
                                <button id="assisted-write-btn" class="writing-mode-btn w-1/2 py-2 rounded-md inactive">Asistida</button>
                            </div>

                            <div id="free-write-area">
                                <textarea id="diary-notes-free" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 text-white h-48" placeholder="Escribe libremente sobre lo que sientes..."></textarea>
                            </div>
                            <div id="assisted-write-area" class="hidden space-y-3">
                                <div>
                                    <label class="text-sm font-medium text-gray-400">¿Qué situación o pensamiento desencadenó esta emoción?</label>
                                    <textarea id="q1-notes" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white mt-1" rows="3"></textarea>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-400">¿En qué parte de tu cuerpo sientes esta emoción?</label>
                                    <textarea id="q2-notes" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white mt-1" rows="3"></textarea>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-400">¿Qué necesitas en este momento?</label>
                                    <textarea id="q3-notes" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2 text-white mt-1" rows="3"></textarea>
                                </div>
                            </div>
                            <button id="add-to-diary-btn" class="w-full mt-4 bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition">Añadir al Diario</button>
                            <button id="restart-btn" class="w-full mt-2 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition">Empezar de Nuevo</button>
                        </div>
                    </div>
                    <div class="w-full md:w-1/2 bg-gray-800 rounded-2xl p-6 shadow-xl border border-gray-700 flex-1 flex flex-col overflow-hidden">
                        <h3 class="text-2xl font-bold mb-4 flex-shrink-0">Mi Diario Emocional</h3>
                        <div id="diary-entries" class="space-y-4 pr-2 overflow-y-auto">
                            <!-- Diary entries will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        // ===================================================================================
        // NOTA IMPORTANTE PARA EJECUTAR EN LOCAL
        // ===================================================================================
        // 1. NO ABRAS ESTE ARCHIVO DIRECTAMENTE: Este código usa Módulos de JavaScript (import)
        //    y no funcionará si lo abres como un archivo local (file://...).
        //
        // 2. USA UN SERVIDOR LOCAL: La forma más fácil es usar la extensión "Live Server"
        //    en el editor Visual Studio Code. Haz clic derecho en el archivo y elige
        //    "Open with Live Server".
        //
        // 3. CONFIGURA FIREBASE: Para que el diario guarde tus datos, necesitas tu propia
        //    configuración de Firebase.
        //      a. Crea un proyecto gratis en https://firebase.google.com/
        //      b. Ve a la configuración de tu proyecto (Project Settings) -> General.
        //      c. En la sección "Your apps", crea una nueva "Web app".
        //      d. Copia el objeto `firebaseConfig` que te proporcionan.
        //      e. Pega ese objeto en la constante `firebaseConfig` de abajo.
        // ===================================================================================

        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, collection, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        import { firebaseConfig } from './firebase-config.js';

        // --- CORRECCIÓN: VERIFICACIÓN DE CONFIGURACIÓN DE FIREBASE ---
        const isFirebaseConfigured = firebaseConfig.apiKey && firebaseConfig.apiKey !== "AIzaSyAY8TjeAIY6Q3AOkTvFw0p2FwtAGfMqrWo";
        let app, auth, db;

        if (isFirebaseConfigured) {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } else {
            console.warn("ADVERTENCIA: La configuración de Firebase no se ha proporcionado. La aplicación se ejecutará en modo de demostración. El diario no funcionará.");
        }

        let userId = null;
        let selectedPrimaryEmotion = null;
        let selectedSecondaryEmotion = null;
        const appId = isFirebaseConfigured ? firebaseConfig.projectId : 'demo-app';

        // --- EMOTION DATA (with descriptions) ---
        const emotionData = {
            name: "Emociones",
            children: [
                { name: "Alegría", color: "#FBBF24", description: "Sentimiento de placer y satisfacción, usualmente por algo bueno que sucede.", children: [
                    { name: "Éxtasis", color: "#F59E0B", description: "Una alegría abrumadora, un gozo supremo.", children: [{name: "Júbilo"}, {name: "Euforia"}] },
                    { name: "Serenidad", color: "#FCD34D", description: "Un estado de calma, paz y tranquilidad.", children: [{name: "Paz"}, {name: "Calma"}] },
                ]},
                { name: "Confianza", color: "#34D399", description: "Seguridad en uno mismo o en los demás; sentimiento de fiabilidad.", children: [
                    { name: "Admiración", color: "#10B981", description: "Aprecio profundo por las cualidades de alguien o algo.", children: [{name: "Aprobación"}, {name: "Respeto"}] },
                    { name: "Aceptación", color: "#6EE7B7", description: "Sentimiento de ser acogido y pertenecer a un grupo.", children: [{name: "Pertenencia"}, {name: "Seguridad"}] }
                ]},
                { name: "Miedo", color: "#A78BFA", description: "Respuesta a una amenaza o peligro percibido, real o imaginario.", children: [
                    { name: "Terror", color: "#8B5CF6", description: "Un miedo extremo e incontrolable.", children: [{name: "Pánico"}, {name: "Horror"}] },
                    { name: "Aprensión", color: "#C4B5FD", description: "Ansiedad o temor de que algo malo suceda.", children: [{name: "Ansiedad"}, {name: "Preocupación"}] }
                ]},
                { name: "Sorpresa", color: "#F472B6", description: "Reacción a algo inesperado, que puede ser agradable o desagradable.", children: [
                    { name: "Asombro", color: "#EC4899", description: "Una sorpresa mezclada con admiración y maravilla.", children: [{name: "Estupor"}, {name: "Maravilla"}] },
                    { name: "Distracción", color: "#F9A8D4", description: "Pérdida de concentración por un evento imprevisto.", children: [{name: "Confusión"}, {name: "Desconcierto"}] }
                ]},
                { name: "Tristeza", color: "#60A5FA", description: "Sentimiento de pena, pérdida o infelicidad.", children: [
                    { name: "Pena", color: "#3B82F6", description: "Un dolor emocional profundo, a menudo por una pérdida.", children: [{name: "Duelo"}, {name: "Desesperación"}] },
                    { name: "Pensatividad", color: "#93C5FD", description: "Un estado de reflexión tranquila y melancólica.", children: [{name: "Nostalgia"}, {name: "Melancolía"}] }
                ]},
                { name: "Asco", color: "#9CA3AF", description: "Fuerte aversión o repulsión hacia algo considerado desagradable.", children: [
                    { name: "Aversión", color: "#6B7280", description: "Un rechazo o disgusto intenso.", children: [{name: "Repugnancia"}, {name: "Rechazo"}] },
                    { name: "Aburrimiento", color: "#D1D5DB", description: "Falta de interés o cansancio por algo monótono.", children: [{name: "Indiferencia"}, {name: "Desinterés"}] }
                ]},
                { name: "Ira", color: "#F87171", description: "Fuerte sentimiento de enfado, irritación o indignación.", children: [
                    { name: "Furia", color: "#EF4444", description: "Una ira violenta y fuera de control.", children: [{name: "Rabia"}, {name: "Odio"}] },
                    { name: "Enfado", color: "#FCA5A5", description: "Irritación o molestia de menor intensidad.", children: [{name: "Irritación"}, {name: "Frustración"}] }
                ]},
                { name: "Anticipación", color: "#22D3EE", description: "Expectativa o esperanza sobre algo que va a suceder.", children: [
                    { name: "Vigilancia", color: "#06B6D4", description: "Estar alerta y atento a posibles eventos.", children: [{name: "Alerta"}, {name: "Expectación"}] },
                    { name: "Interés", color: "#67E8F9", description: "Curiosidad y atención hacia algo.", children: [{name: "Curiosidad"}, {name: "Atención"}] }
                ]}
            ]
        };

        // --- AUTH & PROFILE LOGIC ---
        if (isFirebaseConfigured) {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    const profileDoc = await getDoc(doc(db, `artifacts/${appId}/users/${userId}/profile`, "userProfile"));
                    if (profileDoc.exists()) {
                        document.getElementById('welcome-message').textContent = `Hola, ${profileDoc.data().firstName}`;
                        showAppContent();
                        loadDiaryEntries();
                    } else {
                        document.getElementById('welcome-modal').classList.remove('hidden');
                    }
                } else {
                    signInAnonymously(auth).catch(console.error);
                }
            });
        } else {
            // Si no hay configuración, se inicia en modo demo.
            window.addEventListener('DOMContentLoaded', () => {
                document.getElementById('welcome-message').textContent = `Modo Demostración`;
                showAppContent();
                loadDiaryEntries(); // Cargará el estado vacío/desactivado
            });
        }

        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isFirebaseConfigured) return;
            const firstName = document.getElementById('first-name').value;
            const lastName = document.getElementById('last-name').value;
            if (firstName && lastName && userId) {
                await setDoc(doc(db, `artifacts/${appId}/users/${userId}/profile`, "userProfile"), { firstName, lastName });
                document.getElementById('welcome-message').textContent = `Hola, ${firstName}`;
                showAppContent();
                loadDiaryEntries();
            }
        });

        function showAppContent() {
            gsap.to('#welcome-modal', { opacity: 0, duration: 0.5, onComplete: () => document.getElementById('welcome-modal').classList.add('hidden') });
            document.getElementById('app-content').classList.remove('hidden');
            gsap.from('#app-content', { opacity: 0, duration: 1, delay: 0.5 });
            showStep(1);
        }

        // --- STEP & VIEW MANAGEMENT ---
        const stepTitleEl = document.getElementById('step-title');
        const stepSubtitleEl = document.getElementById('step-subtitle');
        const emotionDescriptionEl = document.getElementById('emotion-description-header');

        function showStep(stepNumber, data = {}) {
            const tl = gsap.timeline();
            tl.to("#step-header, #content-area", { opacity: 0, duration: 0.3 });

            tl.call(() => {
                document.querySelectorAll('.step-content-container').forEach(el => el.style.display = 'none');
                switch(stepNumber) {
                    case 1:
                        stepTitleEl.textContent = "Paso 1: Identifica tu emoción";
                        stepSubtitleEl.textContent = "Respira profundo. ¿Cuál de estas emociones resuena más contigo ahora?";
                        emotionDescriptionEl.textContent = "";
                        drawPrimaryMap();
                        document.getElementById('step1-content').style.display = 'flex';
                        break;
                    case 2:
                        stepTitleEl.textContent = `Paso 2: Explorando ${data.name}`;
                        stepSubtitleEl.textContent = "Dentro de esta familia, ¿qué emoción específica sientes?";
                        emotionDescriptionEl.textContent = data.description || "";
                        drawSecondaryMap(data);
                        document.getElementById('step2-content').style.display = 'flex';
                        break;
                    case 3:
                        stepTitleEl.innerHTML = `<span class="text-gray-400">Ruta:</span> ${data.primary.name} <span class="text-gray-500 mx-2">&rarr;</span> ${data.secondary.name}`;
                        stepSubtitleEl.textContent = "Ahora, tómate un momento para registrar cómo te sientes.";
                        emotionDescriptionEl.textContent = data.secondary.description || "";
                        document.getElementById('step3-content').style.display = 'flex';
                        break;
                }
            });

            tl.to("#step-header, #content-area", { opacity: 1, duration: 0.5 });
        }

        // --- D3 MAP DRAWING LOGIC ---
        const width = 600;
        const height = 600;
        const radius = Math.min(width, height) / 2;

        function drawPrimaryMap() {
            const svg = d3.select("#primary-emotion-map");
            svg.selectAll("*" ).remove();
            const g = svg.append("g").attr("transform", `translate(${width / 2},${height / 2})`);
            const pie = d3.pie().value(1).sort(null);
            const arc = d3.arc().innerRadius(radius * 0.55).outerRadius(radius * 0.95);
            
            const arcs = g.selectAll(".emotion-arc-group")
                .data(pie(emotionData.children))
                .enter().append("g")
                .attr("class", "emotion-arc-group")
                .on("click", (event, d) => handlePrimarySelection(d.data));
            
            arcs.append("path")
                .attr("d", arc)
                .attr("fill", d => d.data.color)
                .attr("class", "emotion-arc-path");

            arcs.append("text")
                .attr("transform", d => `translate(${arc.centroid(d)})`)
                .attr("class", "emotion-label")
                .style("font-size", "18px")
                .text(d => d.data.name);
            
            g.append("text").attr("text-anchor", "middle").attr("dy", "0.35em").attr("class", "emotion-label").style("font-size", "24px").text("Emociones");
        }

        function drawSecondaryMap(data) {
            const svg = d3.select("#secondary-emotion-map");
            svg.selectAll("*" ).remove();
            
            const root = d3.hierarchy(data).sum(d => (d.children && d.children.length > 0) ? 0 : 1).sort((a, b) => b.value - a.value);
            const partition = d3.partition().size([2 * Math.PI, radius * 1.1]);
            partition(root);
            
            const g = svg.append("g").attr("transform", `translate(${width / 2},${height / 2})`);
            const arc = d3.arc()
                .startAngle(d => d.x0)
                .endAngle(d => d.x1)
                .padAngle(0.01)
                .innerRadius(d => d.y0 * 0.8)
                .outerRadius(d => d.y1 * 0.8);

            const groups = g.selectAll(".emotion-arc-group")
                .data(root.descendants().slice(1))
                .join("g")
                .attr("class", "emotion-arc-group")
                .on("click", (event, d) => handleSecondarySelection(d.data));
            
            groups.append("path")
                .attr("d", arc)
                .attr("fill", d => d.data.color || d.parent.data.color)
                .attr("class", "emotion-arc-path");

            groups.append("text")
                .attr("class", "emotion-label")
                .style("font-size", "16px")
                .attr("transform", function(d) {
                    const x = (d.x0 + d.x1) / 2 * 180 / Math.PI;
                    const y = (d.y0 + d.y1) / 2 * 0.8;
                    return `rotate(${x - 90}) translate(${y},0) rotate(${x < 180 ? 0 : 180})`;
                })
                .attr("dy", "0.35em")
                .text(d => d.data.name);
            
            const center = g.append("g").style("cursor", "pointer").on("click", () => showStep(1));
            center.append("circle").attr("r", radius * 0.25).attr("fill", data.color);
            center.append("text").attr("text-anchor", "middle").attr("dy", "0.35em").attr("class", "emotion-label").style("font-size", "20px").text(data.name);
        }

        // --- SELECTION HANDLERS ---
        function handlePrimarySelection(data) {
            selectedPrimaryEmotion = data;
            showStep(2, data);
        }

        function handleSecondarySelection(data) {
            selectedSecondaryEmotion = data;
            showStep(3, { primary: selectedPrimaryEmotion, secondary: data });
        }

        // --- DIARY LOGIC ---
        document.getElementById('restart-btn').addEventListener('click', () => showStep(1));

        const freeWriteBtn = document.getElementById('free-write-btn');
        const assistedWriteBtn = document.getElementById('assisted-write-btn');
        const freeWriteArea = document.getElementById('free-write-area');
        const assistedWriteArea = document.getElementById('assisted-write-area');

        freeWriteBtn.addEventListener('click', () => {
            freeWriteBtn.classList.replace('inactive', 'active');
            assistedWriteBtn.classList.replace('active', 'inactive');
            freeWriteArea.classList.remove('hidden');
            assistedWriteArea.classList.add('hidden');
        });

        assistedWriteBtn.addEventListener('click', () => {
            assistedWriteBtn.classList.replace('inactive', 'active');
            freeWriteBtn.classList.replace('active', 'inactive');
            assistedWriteArea.classList.remove('hidden');
            freeWriteArea.classList.add('hidden');
        });

        document.getElementById('add-to-diary-btn').addEventListener('click', async () => {
            if (!isFirebaseConfigured) {
                alert("El diario está desactivado en modo de demostración. Por favor, configura tus claves de Firebase para guardar entradas.");
                return;
            }
            if (!selectedSecondaryEmotion || !userId) return;
            
            let notes = '';
            if (freeWriteBtn.classList.contains('active')) {
                notes = document.getElementById('diary-notes-free').value;
            } else {
                const q1 = document.getElementById('q1-notes').value;
                const q2 = document.getElementById('q2-notes').value;
                const q3 = document.getElementById('q3-notes').value;
                notes = `Desencadenante: ${q1}\n\nSensación corporal: ${q2}\n\nNecesidad: ${q3}`;
            }

            const entry = {
                emotion: selectedSecondaryEmotion.name,
                path: `${selectedPrimaryEmotion.name} > ${selectedSecondaryEmotion.name}`,
                color: selectedSecondaryEmotion.color || selectedPrimaryEmotion.color,
                notes: notes,
                date: new Date().toISOString()
            };

            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/diaryEntries`), entry);
                document.getElementById('diary-notes-free').value = '';
                document.getElementById('q1-notes').value = '';
                document.getElementById('q2-notes').value = '';
                document.getElementById('q3-notes').value = '';
                showStep(1);
            } catch (error) {
                console.error("Error adding diary entry:", error);
            }
        });

        function loadDiaryEntries() {
            const container = document.getElementById('diary-entries');
            if (!isFirebaseConfigured) {
                container.innerHTML = `<p class="text-gray-400 text-center p-4 bg-gray-700 rounded-lg">El diario está desactivado. Añade tu configuración de Firebase para guardar tus entradas.</p>`;
                return;
            }
            if (!userId) return;

            const q = query(collection(db, `artifacts/${appId}/users/${userId}/diaryEntries`));
            onSnapshot(q, (snapshot) => {
                const entries = [];
                snapshot.forEach(doc => entries.push({ id: doc.id, ...doc.data() }));
                entries.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                container.innerHTML = '';
                if (entries.length === 0) {
                    container.innerHTML = `<p class="text-gray-400 text-center">Tu diario está vacío. Completa una ruta para empezar.</p>`;
                } else {
                    entries.forEach(entry => {
                        const el = document.createElement('div');
                        el.className = 'bg-gray-700 p-4 rounded-lg';
                        const date = new Date(entry.date);
                        el.innerHTML = `
                            <div class="flex items-center mb-2">
                                <span class="w-3 h-3 rounded-full mr-3" style="background-color: ${entry.color};"></span>
                                <h4 class="font-bold text-lg">${entry.emotion}</h4>
                            </div>
                            <p class="text-xs text-gray-400 ml-6">${entry.path}</p>
                            <p class="text-gray-300 ml-6 my-2 whitespace-pre-wrap">${entry.notes || '<em>Sin notas.</em>'}</p>
                            <p class="text-xs text-gray-500 text-right">${date.toLocaleDateString('es-ES')} - ${date.toLocaleTimeString('es-ES')}</p>
                        `;
                        container.appendChild(el);
                    });
                }
            });
        }
    </script>
</body>
</html>
